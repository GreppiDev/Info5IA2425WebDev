<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard Admin - Educational Games</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .stat-card {
            text-align: center;
        }

        .stat-card .display-5 {
            font-weight: 500;
        }

        .management-link {
            margin-top: 0.5rem;
        }
    </style>
</head>

<body>

    <div id="navbar-container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div class="container-fluid"><span class="navbar-brand">Caricamento...</span></div>
        </nav>
    </div>

    <main>
        <div class="container mt-4">
            <h1 class="mb-4">Dashboard Amministratore</h1>

            <div id="loading-dashboard" class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p>Caricamento statistiche...</p>
            </div>
            <div id="error-dashboard" class="alert alert-danger d-none"></div>

            <div id="dashboard-content" class="d-none">
                <h2 class="h5 mb-3 text-muted">Statistiche Generali Piattaforma</h2>
                <div class="row g-3 mb-4">
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Utenti Totali</h6>
                                <p class="display-5 text-primary" id="stat-utenti">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Docenti</h6>
                                <p class="display-5 text-info" id="stat-docenti">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Studenti</h6>
                                <p class="display-5 text-success" id="stat-studenti">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Classi</h6>
                                <p class="display-5 text-secondary" id="stat-classi">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Giochi</h6>
                                <p class="display-5 text-danger" id="stat-giochi">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Argomenti</h6>
                                <p class="display-5 text-warning" id="stat-argomenti">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="card shadow-sm stat-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted small">Materie</h6>
                                <p class="display-5 text-dark" id="stat-materie">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <h2 class="h5 mt-4 mb-3 text-muted">Strumenti di Gestione</h2>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="/admin-utenti.html" class="btn btn-outline-primary management-link"><i
                                    class="bi bi-people-fill me-2"></i>Gestione Utenti</a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="/admin-giochi.html" class="btn btn-outline-info management-link"><i
                                    class="bi bi-joystick me-2"></i>Gestione Giochi</a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <a href="/admin-taxonomies.html" class="btn btn-outline-secondary management-link"><i
                                    class="bi bi-tags-fill me-2"></i>Gestione Argomenti/Materie</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="/js/template-loader.js"></script>
    <script src="/js/navbar.js"></script>
    <script>
        // Riferimenti UI
        const loadingDiv = document.getElementById('loading-dashboard');
        const errorDiv = document.getElementById('error-dashboard');
        const dashboardContentDiv = document.getElementById('dashboard-content');
        const statUtenti = document.getElementById('stat-utenti');
        const statDocenti = document.getElementById('stat-docenti');
        const statStudenti = document.getElementById('stat-studenti');
        const statClassi = document.getElementById('stat-classi');
        const statGiochi = document.getElementById('stat-giochi');
        const statArgomenti = document.getElementById('stat-argomenti');
        const statMaterie = document.getElementById('stat-materie');

        // Funzione helper escape HTML
        function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        // Inizializzazione Pagina
        document.addEventListener('DOMContentLoaded', async function () {
            console.log("Admin Dashboard page: Initializing templates...");
            try {
                await TemplateLoader.initializeCommonTemplates();
                await new Promise(resolve => setTimeout(resolve, 0)); // Delay
                let userData = null;
                try { const response = await fetch('/api/account/my-roles'); if (response.ok) userData = await response.json(); else throw new Error('Not logged in'); }
                catch { throw new Error('Auth check failed'); }

                updateNavbar(userData); // Aggiorna navbar
                const dashboardLink = document.getElementById('nav-admin-dashboard')?.querySelector('.nav-link');
                if (dashboardLink) dashboardLink.classList.add('active'); // Imposta link attivo

                // Carica dati dashboard solo se Admin
                if (userData?.isAdmin) {
                    if (loadingDiv) loadingDiv.classList.remove('d-none');
                    const response = await fetch('/api/admin/dashboard/stats');
                    if (!response.ok) {
                        let errorMsg = `Errore ${response.status}`;
                        try { const err = await response.json(); errorMsg = err.title || err.detail || errorMsg; } catch { }
                        throw new Error(errorMsg);
                    }
                    const dashboardData = await response.json();
                    console.log("Admin dashboard data received:", dashboardData);

                    // Popola statistiche
                    if (statUtenti) statUtenti.textContent = dashboardData.totaleUtenti ?? 0;
                    if (statDocenti) statDocenti.textContent = dashboardData.totaleDocenti ?? 0;
                    if (statStudenti) statStudenti.textContent = dashboardData.totaleStudenti ?? 0;
                    if (statClassi) statClassi.textContent = dashboardData.totaleClassi ?? 0;
                    if (statGiochi) statGiochi.textContent = dashboardData.totaleGiochi ?? 0;
                    if (statArgomenti) statArgomenti.textContent = dashboardData.totaleArgomenti ?? 0;
                    if (statMaterie) statMaterie.textContent = dashboardData.totaleMaterie ?? 0;

                    if (dashboardContentDiv) dashboardContentDiv.classList.remove('d-none'); // Mostra contenuto

                } else {
                    // Se non è admin, mostra errore di autorizzazione
                    throw new Error("Accesso non autorizzato (solo Admin).");
                }

            } catch (error) {
                console.error('Error during page initialization:', error);
                if (typeof updateNavbar === 'function') updateNavbar(null); // Aggiorna a stato non loggato
                if (errorDiv) { errorDiv.textContent = `Errore caricamento dashboard: ${error.message}`; errorDiv.classList.remove('d-none'); }
                if (dashboardContentDiv) dashboardContentDiv.classList.add('d-none'); // Nasconde contenuto
            } finally {
                if (loadingDiv) loadingDiv.classList.add('d-none');
            }
        });
        // La funzione postLogout() è definita in navbar.js
    </script>

</body>

</html>